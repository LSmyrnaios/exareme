version: '3.2'

services:
  exareme-keystore:
    image: progrium/consul
    command:
      - -server
      - -bootstrap
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          - node.labels.role == master       # Ensures we only start on master nodes
          - node.labels.name == ${FEDERATION_NODE}
    ports:
      - "8500:8500" # Expose this port here, only during dev-mode (change it manually).

  exareme-master:
    image: ${EXAREME_IMAGE}
    environment:
      - CONSULURL=${EXAREME_KEYSTORE}
      - NODE_NAME=${FEDERATION_NODE}
      - FEDERATION_ROLE=${FEDERATION_ROLE}
      - TEMP_FILES_CLEANUP_TIME=30
      - NODE_COMMUNICATION_TIMEOUT=30000        # (MILIS) NODE COMMUNICATION WILL DROP IF TIMEOUT IS PASSED
      - ENVIRONMENT_TYPE=PROD                   # TEST / DEV / PROD
    depends_on:
      - exareme-keystore
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          - node.labels.role == master # Ensures we only start on master nodes
          - node.labels.name == ${FEDERATION_NODE}
    ports:
      - target: 9090     # So that we can access the Exareme REST API / interface
        published: 9090
        protocol: tcp
        mode: host
    volumes:
      - ${LOCAL_DATA_FOLDER}:${DOCKER_DATA_FOLDER}
